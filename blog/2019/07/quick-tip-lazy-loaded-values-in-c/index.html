<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="with=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="icon" href="/favicon.ico"><!-- Begin SEO -->
  <meta property="og:title" content="Quick Tip: Lazy Loaded Values in C#">
  <meta name="description" content=
  "At my internship, I&rsquo;ve been spending the past few weeks overhauling the authentication and authorization for all of the company&rsquo;s internal applications. The new authorization system uses a third-party service that handles all of the niceties of logging in, two-factor authentication, synchronization with Active Directory permissions, and all the other fluff. All we have to do is set up authentication with OpenId Connect and receive access and id tokens from our third-party provider.">
  <link rel="canonical" href=
  "http://waltermays.com/blog/2019/07/quick-tip-lazy-loaded-values-in-c/">
  <meta property="og:url" content=
  "http://waltermays.com/blog/2019/07/quick-tip-lazy-loaded-values-in-c/">
  <meta property="og:site_name" content="Walter Mays">
  <meta property="og:type" content="article">
  <meta property="article:published_time" content="2019-07-03 20:00:55 -0500 CDT">
  <script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "http://waltermays.com/blog/2019/07/quick-tip-lazy-loaded-values-in-c/"
    },
    "@type": "WebPage",
    "url": "http://waltermays.com/blog/2019/07/quick-tip-lazy-loaded-values-in-c/",
    "headline": "Quick Tip: Lazy Loaded Values in C#",
    "dateModified": "2019-07-03 20:00:55 -0500 CDT",
    "datePublished": "2019-07-03 20:00:55 -0500 CDT",
    "description": "At my internship, I&rsquo;ve been spending the past few weeks overhauling the authentication and authorization for all of the company&rsquo;s internal applications. The new authorization system uses a third-party service that handles all of the niceties of logging in, two-factor authentication, synchronization with Active Directory permissions, and all the other fluff. All we have to do is set up authentication with OpenId Connect and receive access and id tokens from our third-party provider."
  }
  </script><!-- End SEO -->
  <title>Quick Tip: Lazy Loaded Values in C# | Walter Mays</title>
  <link rel="stylesheet" href="/style.css">
</head>
<body>
  <header class="container site-header">
    <div class="site-title">
      <a href="/">Walter Mays</a>
    </div>
    <nav class="nav-links">
      <a href="/" class="nav-link">Home</a> <a href="/learn-you-some-linux/" class="nav-link">Learn
      You Some Linux</a> <a href="/blog/" class="nav-link">Blog</a>
    </nav>
  </header>
  <div id="content">
    <div class="container">
      <h1 class="post-title">Quick Tip: Lazy Loaded Values in C#</h1>
      <header class="post-info">
        July 3, 2019 &bull; <a href="/categories/programming">Programming</a>
      </header>
      <p>At my internship, I&rsquo;ve been spending the past few weeks overhauling the
      authentication and authorization for all of the company&rsquo;s internal applications. The
      new authorization system uses a third-party service that handles all of the niceties of
      logging in, two-factor authentication, synchronization with Active Directory permissions, and
      all the other fluff. All we have to do is set up authentication with <a href=
      "https://openid.net/connect/">OpenId Connect</a> and receive access and id tokens from our
      third-party provider. For the most part this is already handled for us through existing
      middleware, but there are a couple of special cases that require custom handling.</p>
      <p>There are certain cases where an application requires authentication without being able to
      open a web browser. OpenId supports the <a href=
      "https://auth0.com/docs/api-auth/tutorials/password-grant">Resource Owner Password Grant
      Flow</a>, which is a fancy way of saying that the application can absolutely be trusted with
      the username and password of the user. Since these accounts just give access to internal
      systems, this isn&rsquo;t much of an issue. However, to increase security, the responses from
      the authentication service should be verified. Part of this process involves a <em>signing
      key,</em> which ensures that the tokens that the service issued haven&rsquo;t been modified
      by some other party.</p>
      <p>Signing keys can change at any time, which means that any cache that contains them must be
      kept up to date. I considered using Microsoft&rsquo;s own in-memory cache, but found that it
      was cumbersome to use. What I really wanted was a way to define a value that would keep
      itself up-to-date without me having to worry about it. This is the code I came up with to
      generalize that idea:</p>
      <div class="highlight">
        <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class=
        "language-csharp" data-lang="csharp"><span style=
        "color:#204a87;font-weight:bold">using</span> <span style=
        "color:#000">System.Threading</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">namespace</span> <span style=
"color:#000">Utilities</span>
<span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style=
"color:#204a87;font-weight:bold">class</span> <span style=
"color:#000">AsyncCache</span><span style="color:#000;font-weight:bold">&lt;</span><span style=
"color:#000">T</span><span style="color:#000;font-weight:bold">&gt;</span>
    <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">private</span> <span style=
"color:#000">DateTimeOffset</span><span style="color:#000;font-weight:bold">?</span> <span style=
"color:#000">lastLoaded</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#204a87;font-weight:bold">private</span> <span style=
"color:#000">TimeSpan</span> <span style="color:#000">timeout</span><span style=
"color:#000;font-weight:bold">;</span>
        <span style="color:#204a87;font-weight:bold">private</span> <span style=
"color:#000">Func</span><span style="color:#000;font-weight:bold">&lt;</span><span style=
"color:#000">Task</span><span style="color:#000;font-weight:bold">&lt;</span><span style=
"color:#000">T</span><span style="color:#000;font-weight:bold">&gt;&gt;</span> <span style=
"color:#000">loader</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#204a87;font-weight:bold">private</span> <span style=
"color:#000">T</span> <span style="color:#000">item</span><span style=
"color:#000;font-weight:bold">;</span>

        <span style="color:#204a87;font-weight:bold">public</span> <span style=
"color:#000">AsyncCache</span><span style="color:#000;font-weight:bold">(</span><span style=
"color:#000">TimeSpan</span> <span style="color:#000">timeout</span><span style=
"color:#000;font-weight:bold">,</span> <span style="color:#000">Func</span><span style=
"color:#000;font-weight:bold">&lt;</span><span style="color:#000">Task</span><span style=
"color:#000;font-weight:bold">&lt;</span><span style="color:#000">T</span><span style=
"color:#000;font-weight:bold">&gt;&gt;</span> <span style="color:#000">loader</span><span style=
"color:#000;font-weight:bold">)</span>
        <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#204a87;font-weight:bold">this</span><span style=
"color:#000;font-weight:bold">.</span><span style="color:#000">timeout</span> <span style=
"color:#000;font-weight:bold">=</span> <span style="color:#000">timeout</span><span style=
"color:#000;font-weight:bold">;</span>
            <span style="color:#204a87;font-weight:bold">this</span><span style=
"color:#000;font-weight:bold">.</span><span style="color:#000">loader</span> <span style=
"color:#000;font-weight:bold">=</span> <span style="color:#000">loader</span><span style=
"color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">}</span>

        <span style="color:#204a87;font-weight:bold">public</span> <span style=
"color:#204a87;font-weight:bold">async</span> <span style="color:#000">Task</span><span style=
"color:#000;font-weight:bold">&lt;</span><span style="color:#000">T</span><span style=
"color:#000;font-weight:bold">&gt;</span> <span style="color:#000">GetValue</span><span style=
"color:#000;font-weight:bold">()</span>
        <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#204a87;font-weight:bold">var</span> <span style=
"color:#000">current</span> <span style="color:#000;font-weight:bold">=</span> <span style=
"color:#000">DateTimeOffset</span><span style="color:#000;font-weight:bold">.</span><span style=
"color:#000">Now</span><span style="color:#000;font-weight:bold">;</span>
            <span style="color:#204a87;font-weight:bold">if</span> <span style=
"color:#000;font-weight:bold">(!</span><span style="color:#000">lastLoaded</span><span style=
"color:#000;font-weight:bold">.</span><span style="color:#000">HasValue</span> <span style=
"color:#000;font-weight:bold">||</span> <span style=
"color:#000;font-weight:bold">(</span><span style="color:#000">current</span> <span style=
"color:#000;font-weight:bold">-</span> <span style="color:#000">lastLoaded</span><span style=
"color:#000;font-weight:bold">.</span><span style="color:#000">Value</span><span style=
"color:#000;font-weight:bold">)</span> <span style=
"color:#000;font-weight:bold">&gt;</span> <span style="color:#000">timeout</span><span style=
"color:#000;font-weight:bold">)</span>
            <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#204a87;font-weight:bold">await</span> <span style=
"color:#000">Reload</span><span style="color:#000;font-weight:bold">();</span>
            <span style="color:#000;font-weight:bold">}</span>
            <span style="color:#204a87;font-weight:bold">return</span> <span style=
"color:#000">item</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">}</span>

        <span style="color:#204a87;font-weight:bold">public</span> <span style=
"color:#204a87;font-weight:bold">async</span> <span style="color:#000">Task</span> <span style=
"color:#000">Reload</span><span style="color:#000;font-weight:bold">()</span>
        <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000">item</span> <span style=
"color:#000;font-weight:bold">=</span> <span style=
"color:#204a87;font-weight:bold">await</span> <span style="color:#000">loader</span><span style=
"color:#000;font-weight:bold">.</span><span style="color:#000">Invoke</span><span style=
"color:#000;font-weight:bold">();</span>
            <span style="color:#000">lastLoaded</span> <span style=
"color:#000;font-weight:bold">=</span> <span style="color:#000">DateTimeOffset</span><span style=
"color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style=
"color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span></code></pre>
      </div>
      <p>An <code>AsyncCache</code> class can be created to contain any type, including both
      reference and value types. When it&rsquo;s created, it accepts a timeout and a function that
      returns type <code>T</code> asynchronously. Then, whenever <code>GetValue</code> is called,
      it checks to see if the item has been loaded and whether or not the timeout is expired. If
      necessary, it invokes the <code>loader</code> function and then caches that value, resetting
      the timeout.</p>
      <p>Sometimes a signing key might change with time still left on the timeout. If this happens,
      it might be necessary to reload the signing key manually. In that case, the code using this
      class can simply call the <code>Reload</code> method.</p>
      <p>Here&rsquo;s an example of creating and using the <code>AsyncCache</code> class:</p>
      <div class="highlight">
        <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class=
        "language-csharp" data-lang="csharp"><span style=
        "color:#204a87;font-weight:bold">var</span> <span style=
        "color:#000">cachedKey</span> <span style=
        "color:#000;font-weight:bold">=</span> <span style=
        "color:#204a87;font-weight:bold">new</span> <span style=
        "color:#000">AsyncCache</span><span style=
        "color:#000;font-weight:bold">&lt;</span><span style=
        "color:#204a87;font-weight:bold">string</span><span style=
        "color:#000;font-weight:bold">&gt;(</span><span style=
        "color:#000">TimeSpan</span><span style="color:#000;font-weight:bold">.</span><span style=
        "color:#000">FromMinutes</span><span style=
        "color:#000;font-weight:bold">(</span><span style=
        "color:#0000cf;font-weight:bold">5</span><span style=
        "color:#000;font-weight:bold">),</span> <span style=
        "color:#204a87;font-weight:bold">async</span> <span style=
        "color:#000;font-weight:bold">()</span> <span style=
        "color:#000;font-weight:bold">=&gt;</span>
<span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">var</span> <span style=
"color:#000">httpClient</span> <span style="color:#000;font-weight:bold">=</span> <span style=
"color:#204a87;font-weight:bold">new</span> <span style="color:#000">HttpClient</span><span style=
"color:#000;font-weight:bold">();</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style=
"color:#204a87;font-weight:bold">await</span> <span style=
"color:#000">httpClient</span><span style="color:#000;font-weight:bold">.</span><span style=
"color:#000">GetStringAsync</span><span style="color:#000;font-weight:bold">(</span><span style=
"color:#000">url</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#204a87;font-weight:bold">string</span> <span style=
"color:#000">signingKey</span> <span style="color:#000;font-weight:bold">=</span> <span style=
"color:#000">cachedKey</span><span style="color:#000;font-weight:bold">.</span><span style=
"color:#000">GetValue</span><span style="color:#000;font-weight:bold">();</span></code></pre>
      </div>
      <p>This isn&rsquo;t the ideal solution. Since the value is lazy-loaded, it will definitely
      cause some delay when the value is actually requested. I would like to have a good way of
      triggering the loading when the <code>AsyncCache</code> is first instantiated, but I
      haven&rsquo;t yet found a way that doesn&rsquo;t introduce synchronization issues.</p>
      <p>I hope this has been useful to someone. If you have any questions or suggestions, please
      get in touch!</p>
    </div>
  </div>
  <footer>
    <div class="footer-links">
      <span class="footer-item"><a href=
      "mailto://walt@waltermays.com">walt@waltermays.com</a></span> <span class=
      "footer-item"><a href="https://github.com/Sircular">Sircular</a> on Github</span>
    </div>
    <div>
      Proudly Powered by <a href="https://gohugo.io/">Hugo</a>
    </div>
  </footer>
</body>
</html>
